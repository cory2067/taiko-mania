
/*
Sound.js
===============

A complete micro library of useful, modular functions that help you load, play, control
and generate sound effects and music for games and interactive applications. All the
code targets the WebAudio API.
*/
!function(e,t,o){"use strict";function a(e){e&&(e.setTargetAtTime||(e.setTargetAtTime=e.setTargetValueAtTime))}window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")&&(window.AudioContext=webkitAudioContext,AudioContext.prototype.hasOwnProperty("createGain")||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),AudioContext.prototype.hasOwnProperty("createDelay")||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),AudioContext.prototype.hasOwnProperty("createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode),AudioContext.prototype.hasOwnProperty("createPeriodicWave")||(AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable),AudioContext.prototype.internal_createGain=AudioContext.prototype.createGain,AudioContext.prototype.createGain=function(){var e=this.internal_createGain();return a(e.gain),e},AudioContext.prototype.internal_createDelay=AudioContext.prototype.createDelay,AudioContext.prototype.createDelay=function(e){var t=e?this.internal_createDelay(e):this.internal_createDelay();return a(t.delayTime),t},AudioContext.prototype.internal_createBufferSource=AudioContext.prototype.createBufferSource,AudioContext.prototype.createBufferSource=function(){var e=this.internal_createBufferSource();return e.start?(e.internal_start=e.start,e.start=function(t,o,a){void 0!==a?e.internal_start(t||0,o,a):e.internal_start(t||0,o||0)}):e.start=function(e,t,o){t||o?this.noteGrainOn(e||0,t,o):this.noteOn(e||0)},e.stop?(e.internal_stop=e.stop,e.stop=function(t){e.internal_stop(t||0)}):e.stop=function(e){this.noteOff(e||0)},a(e.playbackRate),e},AudioContext.prototype.internal_createDynamicsCompressor=AudioContext.prototype.createDynamicsCompressor,AudioContext.prototype.createDynamicsCompressor=function(){var e=this.internal_createDynamicsCompressor();return a(e.threshold),a(e.knee),a(e.ratio),a(e.reduction),a(e.attack),a(e.release),e},AudioContext.prototype.internal_createBiquadFilter=AudioContext.prototype.createBiquadFilter,AudioContext.prototype.createBiquadFilter=function(){var e=this.internal_createBiquadFilter();return a(e.frequency),a(e.detune),a(e.Q),a(e.gain),e},AudioContext.prototype.hasOwnProperty("createOscillator")&&(AudioContext.prototype.internal_createOscillator=AudioContext.prototype.createOscillator,AudioContext.prototype.createOscillator=function(){var e=this.internal_createOscillator();return e.start?(e.internal_start=e.start,e.start=function(t){e.internal_start(t||0)}):e.start=function(e){this.noteOn(e||0)},e.stop?(e.internal_stop=e.stop,e.stop=function(t){e.internal_stop(t||0)}):e.stop=function(e){this.noteOff(e||0)},e.setPeriodicWave||(e.setPeriodicWave=e.setWaveTable),a(e.frequency),a(e.detune),e})),window.hasOwnProperty("webkitOfflineAudioContext")&&!window.hasOwnProperty("OfflineAudioContext")&&(window.OfflineAudioContext=webkitOfflineAudioContext)}(window);var actx=new AudioContext,sounds={toLoad:0,loaded:0,audioExtensions:["mp3","ogg","wav","webm"],whenLoaded:void 0,onProgress:void 0,onFailed:function(e,t){throw new Error("Audio could not be loaded: "+e)},load:function(e){console.log("Loading sounds..");var t=this;t.toLoad=e.length,e.forEach(function(e){var o=e.split(".").pop();if(-1!==t.audioExtensions.indexOf(o)){var a=makeSound(e,t.loadHandler.bind(t),!0,!1,t.onFailed);a.name=e,t[a.name]=a}else console.log("File type not recognized: "+e)})},loadHandler:function(){var e=this;e.loaded+=1,e.onProgress&&e.onProgress(100*e.loaded/e.toLoad),e.toLoad===e.loaded&&(console.log("Sounds finished loading"),e.toLoad=0,e.loaded=0,e.whenLoaded())}};function makeSound(e,t,o,a,n){var r={};return r.volumeNode=actx.createGain(),actx.createStereoPanner?r.panNode=actx.createStereoPanner():r.panNode=actx.createPanner(),r.delayNode=actx.createDelay(),r.feedbackNode=actx.createGain(),r.filterNode=actx.createBiquadFilter(),r.convolverNode=actx.createConvolver(),r.soundNode=null,r.buffer=null,r.source=e,r.loop=!1,r.playing=!1,r.loadHandler=void 0,r.panValue=0,r.volumeValue=1,r.startTime=0,r.startOffset=0,r.playbackRate=1,r.echo=!1,r.delayValue=.3,r.feebackValue=.3,r.filterValue=0,r.reverb=!1,r.reverbImpulse=null,r.play=function(){r.startTime=actx.currentTime,r.soundNode=actx.createBufferSource(),r.soundNode.buffer=r.buffer,r.soundNode.playbackRate.value=this.playbackRate,r.soundNode.connect(r.volumeNode),!1===r.reverb?r.volumeNode.connect(r.panNode):(r.volumeNode.connect(r.convolverNode),r.convolverNode.connect(r.panNode),r.convolverNode.buffer=r.reverbImpulse),r.panNode.connect(actx.destination),r.echo&&(r.feedbackNode.gain.value=r.feebackValue,r.delayNode.delayTime.value=r.delayValue,r.filterNode.frequency.value=r.filterValue,r.delayNode.connect(r.feedbackNode),r.filterValue>0?(r.feedbackNode.connect(r.filterNode),r.filterNode.connect(r.delayNode)):r.feedbackNode.connect(r.delayNode),r.volumeNode.connect(r.delayNode),r.delayNode.connect(r.panNode)),r.soundNode.loop=r.loop,r.soundNode.start(0,r.startOffset%r.buffer.duration),r.playing=!0},r.pause=function(){r.playing&&(r.soundNode.stop(0),r.startOffset+=actx.currentTime-r.startTime,r.playing=!1)},r.restart=function(){r.playing&&r.soundNode.stop(0),r.startOffset=0,r.play()},r.playFrom=function(e){r.playing&&r.soundNode.stop(0),r.startOffset=e,r.play()},r.setEcho=function(e,t,o){void 0===e&&(e=.3),void 0===t&&(t=.3),void 0===o&&(o=0),r.delayValue=e,r.feebackValue=t,r.filterValue=o,r.echo=!0},r.setReverb=function(e,t,o){void 0===e&&(e=2),void 0===t&&(t=2),void 0===o&&(o=!1),r.reverbImpulse=impulseResponse(e,t,o,actx),r.reverb=!0},r.fade=function(e,t){r.playing&&(r.volumeNode.gain.linearRampToValueAtTime(r.volumeNode.gain.value,actx.currentTime),r.volumeNode.gain.linearRampToValueAtTime(e,actx.currentTime+t))},r.fadeIn=function(e){r.volumeNode.gain.value=0,r.fade(1,e)},r.fadeOut=function(e){r.fade(0,e)},Object.defineProperties(r,{volume:{get:function(){return r.volumeValue},set:function(e){r.volumeNode.gain.value=e,r.volumeValue=e},enumerable:!0,configurable:!0},pan:{get:function(){return actx.createStereoPanner?r.panNode.pan.value:r.panValue},set:function(e){if(actx.createStereoPanner)r.panNode.pan.value=e;else{var t=e,o=1-Math.abs(t);r.panNode.setPosition(t,0,o),r.panValue=e}},enumerable:!0,configurable:!0}}),o&&this.loadSound(r,e,t,n),a&&this.decodeAudio(r,a,t,n),r}function loadSound(e,t,o,a){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.addEventListener("load",decodeAudio.bind(this,e,n,o,a)),n.send()}function decodeAudio(e,t,o,a){actx.decodeAudioData(t.response,function(t){e.buffer=t,e.hasLoaded=!0,o&&o()},function(t){a&&a(e.source,t)})}function soundEffect(e,t,o,a,n,r,i,c,u,d,l,s,p,f){var v,y,x,m;void 0===e&&(e=200),void 0===t&&(t=0),void 0===o&&(o=1),void 0===a&&(a="sine"),void 0===n&&(n=1),void 0===r&&(r=0),void 0===i&&(i=0),void 0===c&&(c=0),void 0===u&&(u=!1),void 0===d&&(d=0),void 0===l&&(l=0),void 0===s&&(s=void 0),void 0===p&&(p=void 0),void 0===f&&(f=void 0),v=actx.createOscillator(),y=actx.createGain(),x=actx.createStereoPanner?actx.createStereoPanner():actx.createPanner(),v.connect(y),y.connect(x),x.connect(actx.destination),y.gain.value=n,actx.createStereoPanner?x.pan.value=r:x.setPosition(r,0,1-Math.abs(r)),v.type=a;var A,h;function N(e){var t=actx.createConvolver();t.buffer=impulseResponse(p[0],p[1],p[2],actx),e.connect(t),t.connect(x)}function T(e){var t=actx.createGain(),o=actx.createDelay(),a=actx.createBiquadFilter();o.delayTime.value=s[0],t.gain.value=s[1],s[2]&&(a.frequency.value=s[2]),o.connect(t),s[2]?(t.connect(a),a.connect(o)):t.connect(o),e.connect(o),o.connect(x)}function C(e){e.gain.value=0,e.gain.linearRampToValueAtTime(0,actx.currentTime+i),e.gain.linearRampToValueAtTime(n,actx.currentTime+i+t)}function g(e){e.gain.linearRampToValueAtTime(n,actx.currentTime+t+i),e.gain.linearRampToValueAtTime(0,actx.currentTime+i+t+o)}function b(e){var a=e.frequency.value;u?(e.frequency.linearRampToValueAtTime(a,actx.currentTime+i),e.frequency.linearRampToValueAtTime(a+c,actx.currentTime+i+t+o)):(e.frequency.linearRampToValueAtTime(a,actx.currentTime+i),e.frequency.linearRampToValueAtTime(a-c,actx.currentTime+i+t+o))}function w(e){e.start(actx.currentTime+i),e.stop(actx.currentTime+i+2)}d>0?(A=e-d/2,h=e+d/2,m=Math.floor(Math.random()*(h-A+1))+A):m=e,v.frequency.value=m,t>0&&C(y),g(y),c>0&&b(v),s&&T(y),p&&N(y),l>0&&function(){var e=actx.createOscillator(),a=actx.createOscillator(),r=actx.createGain(),i=actx.createGain();r.gain.value=n,i.gain.value=n,e.connect(r),r.connect(actx.destination),a.connect(i),i.connect(actx.destination),e.type="sawtooth",a.type="sawtooth",e.frequency.value=m+l,a.frequency.value=m-l,t>0&&(C(r),C(i));o>0&&(g(r),g(i));c>0&&(b(e),b(a));s&&(T(r),T(i));p&&(N(r),N(i));w(e),w(a)}(),w(v)}function impulseResponse(e,t,o,a){for(var n=a.sampleRate*e,r=a.createBuffer(2,n,a.sampleRate),i=r.getChannelData(0),c=r.getChannelData(1),u=0;u<n;u++){var d;d=o?n-u:u,i[u]=(2*Math.random()-1)*Math.pow(1-d/n,t),c[u]=(2*Math.random()-1)*Math.pow(1-d/n,t)}return r}
